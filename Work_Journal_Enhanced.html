<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>×™×•××Ÿ ×¢×‘×•×“×” ×“×™×’×™×˜×œ×™ - Stonhard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Heebo', Arial, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            direction: rtl;
            -webkit-font-smoothing: antialiased;
            padding-bottom: 30px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 10px;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #1a3d5c 0%, #2d5a7b 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(26, 61, 92, 0.2);
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            margin-top: 10px;
        }
        
        .status-draft { background: #f39c12; color: white; }
        .status-sent { background: #3498db; color: white; }
        .status-validated { background: #27ae60; color: white; }
        .status-completed { background: #8e44ad; color: white; }
        
        /* Section */
        .section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a3d5c;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e1e8ed;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Form Elements */
        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        @media (min-width: 600px) {
            .form-row.cols-2 { grid-template-columns: 1fr 1fr; }
            .form-row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 6px;
        }
        
        input, select, textarea {
            padding: 12px;
            border: 1.5px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #1a3d5c;
            box-shadow: 0 0 0 3px rgba(26, 61, 92, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        
        table th {
            background: #1a3d5c;
            color: white;
            padding: 12px 8px;
            text-align: right;
            font-size: 13px;
            font-weight: 600;
        }
        
        table td {
            padding: 8px;
            border-bottom: 1px solid #e1e8ed;
        }
        
        table td input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .add-row-btn {
            background: #1a3d5c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
        
        .add-row-btn:active {
            transform: scale(0.98);
        }
        
        /* Signature Pad */
        .signature-container {
            margin-bottom: 20px;
        }
        
        .signature-pad {
            border: 2px solid #1a3d5c;
            border-radius: 8px;
            cursor: crosshair;
            touch-action: none;
            width: 100%;
            height: 150px;
            background: #fafafa;
        }
        
        .signature-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .signature-controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-clear {
            background: #e74c3c;
            color: white;
        }
        
        .btn-save {
            background: #27ae60;
            color: white;
        }
        
        /* Photo Upload */
        .photo-upload {
            border: 2px dashed #1a3d5c;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .photo-upload:hover {
            background: #f8f9fa;
            border-color: #2d5a7b;
        }
        
        .photo-upload input[type="file"] {
            display: none;
        }
        
        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .photo-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }
        
        .photo-item .remove-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: #1a3d5c;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-info {
            background: #3498db;
            color: white;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-whatsapp {
            background: #25D366;
            color: white;
        }
        
        .btn-email {
            background: #e74c3c;
            color: white;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1a3d5c;
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-footer button {
            flex: 1;
        }
        
        /* Alert */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Workflow Steps */
        .workflow-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            position: relative;
            padding: 0 10px;
        }
        
        .workflow-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: #ddd;
            z-index: 0;
        }
        
        .workflow-step {
            text-align: center;
            position: relative;
            z-index: 1;
            flex: 1;
        }
        
        .workflow-step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #ddd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-weight: 700;
            font-size: 18px;
        }
        
        .workflow-step.active .workflow-step-circle {
            background: #3498db;
        }
        
        .workflow-step.completed .workflow-step-circle {
            background: #27ae60;
        }
        
        .workflow-step-label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }
        
        @media (max-width: 600px) {
            .workflow-step-label {
                font-size: 10px;
            }
            .workflow-step-circle {
                width: 35px;
                height: 35px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ“ ×™×•××Ÿ ×¢×‘×•×“×” ×“×™×’×™×˜×œ×™</h1>
            <div>
                <span id="currentStatus" class="status-badge status-draft">×˜×™×•×˜×”</span>
            </div>
        </div>

        <!-- Workflow Progress -->
        <div class="section">
            <div class="workflow-steps" id="workflowSteps">
                <div class="workflow-step active" data-step="1">
                    <div class="workflow-step-circle">1</div>
                    <div class="workflow-step-label">××™×œ×•×™<br>×× ×”×œ ×¢×‘×•×“×”</div>
                </div>
                <div class="workflow-step" data-step="2">
                    <div class="workflow-step-circle">2</div>
                    <div class="workflow-step-label">×—×ª×™××”<br>×•×©×œ×™×—×”</div>
                </div>
                <div class="workflow-step" data-step="3">
                    <div class="workflow-step-circle">3</div>
                    <div class="workflow-step-label">××™×©×•×¨<br>×‘×¢×œ/×× ×”×œ</div>
                </div>
                <div class="workflow-step" data-step="4">
                    <div class="workflow-step-circle">âœ“</div>
                    <div class="workflow-step-label">×”×—×–×¨×”<br>×—×ª×•×</div>
                </div>
            </div>
        </div>

        <!-- Project Info -->
        <div class="section">
            <div class="section-title">
                <span>ğŸ“‹</span> ×¤×¨×˜×™ ×¤×¨×•×™×™×§×˜
            </div>
            <div class="form-row cols-2">
                <div class="form-group">
                    <label>×©× ×¤×¨×•×™×™×§×˜:</label>
                    <input type="text" id="projectName" placeholder="×ª××¨ ×’×¨×•×¤ - ×§×™×¡×¨×™×”">
                </div>
                <div class="form-group">
                    <label>×ª××¨×™×š:</label>
                    <input type="date" id="reportDate">
                </div>
            </div>
            <div class="form-row cols-2">
                <div class="form-group">
                    <label>×× ×”×œ ×¢×‘×•×“×”:</label>
                    <input type="text" id="foremanName" placeholder="×©× ××œ×">
                </div>
                <div class="form-group">
                    <label>××–×’ ××•×•×™×¨:</label>
                    <select id="weather">
                        <option value="">×‘×—×¨...</option>
                        <option value="sunny">â˜€ï¸ ×©××©</option>
                        <option value="cloudy">â›… ××¢×•× ×Ÿ</option>
                        <option value="rainy">ğŸŒ§ï¸ ×’×©×•×</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Work Hours -->
        <div class="section">
            <div class="section-title">
                <span>â°</span> ×©×¢×•×ª ×¢×‘×•×“×”
            </div>
            <div class="form-row cols-3">
                <div class="form-group">
                    <label>×”×ª×—×œ×”:</label>
                    <input type="time" id="startTime">
                </div>
                <div class="form-group">
                    <label>×¡×™×•×:</label>
                    <input type="time" id="endTime">
                </div>
                <div class="form-group">
                    <label>×”×¤×¡×§×•×ª (×©×¢×•×ª):</label>
                    <input type="number" id="breakHours" value="0" step="0.5" min="0">
                </div>
            </div>
        </div>

        <!-- Workforce -->
        <div class="section">
            <div class="section-title">
                <span>ğŸ‘·</span> ×›×•×— ××“×
            </div>
            <div style="overflow-x: auto;">
                <table id="workforceTable">
                    <thead>
                        <tr>
                            <th>×ª×¤×§×™×“</th>
                            <th>××¡×¤×¨</th>
                            <th>×©×¢×•×ª</th>
                            <th>×”×¢×¨×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="workforceBody">
                        <tr>
                            <td><input type="text" placeholder="×ª×¤×§×™×“"></td>
                            <td><input type="number" min="0"></td>
                            <td><input type="number" step="0.5" min="0"></td>
                            <td><input type="text"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <button class="add-row-btn" onclick="addRow('workforce')">
                <span>â•</span> ×”×•×¡×£ ×©×•×¨×”
            </button>
        </div>

        <!-- Activities -->
        <div class="section">
            <div class="section-title">
                <span>ğŸ”¨</span> ×¤×¢×™×œ×•×™×•×ª
            </div>
            <div style="overflow-x: auto;">
                <table id="activitiesTable">
                    <thead>
                        <tr>
                            <th>×ª×™××•×¨ ×¢×‘×•×“×”</th>
                            <th>××™×§×•×</th>
                            <th>×›××•×ª</th>
                            <th>×”×¢×¨×•×ª</th>
                        </tr>
                    </thead>
                    <tbody id="activitiesBody">
                        <tr>
                            <td><input type="text" placeholder="×ª×™××•×¨"></td>
                            <td><input type="text" placeholder="××™×§×•×"></td>
                            <td><input type="text" placeholder="×›××•×ª"></td>
                            <td><input type="text"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <button class="add-row-btn" onclick="addRow('activities')">
                <span>â•</span> ×”×•×¡×£ ×©×•×¨×”
            </button>
        </div>

        <!-- General Notes -->
        <div class="section">
            <div class="section-title">
                <span>ğŸ“</span> ×”×¢×¨×•×ª ×›×œ×œ×™×•×ª
            </div>
            <textarea id="generalNotes" placeholder="×”×¢×¨×•×ª, ×‘×¢×™×•×ª, ××• × ×§×•×“×•×ª ×œ×ª×©×•××ª ×œ×‘..."></textarea>
        </div>

        <!-- Foreman Signature -->
        <div class="section signature-container">
            <div class="section-title">
                <span>âœï¸</span> ×—×ª×™××ª ×× ×”×œ ×¢×‘×•×“×”
            </div>
            <canvas id="foremanSignature" class="signature-pad" width="800" height="150"></canvas>
            <div class="signature-controls">
                <button class="btn-clear" onclick="clearSignature('foreman')">ğŸ—‘ï¸ × ×§×”</button>
                <button class="btn-save" onclick="saveSignature('foreman')">ğŸ’¾ ×©××•×¨ ×—×ª×™××”</button>
            </div>
        </div>

        <!-- Owner/Manager Signature Section -->
        <div class="section signature-container" id="ownerSection" style="display:none;">
            <div class="section-title">
                <span>âœï¸</span> ×—×ª×™××ª ×‘×¢×œ/×× ×”×œ ×¤×¨×•×™×™×§×˜
            </div>
            
            <div class="form-group" style="margin-bottom: 15px;">
                <label>×©× ×××©×¨:</label>
                <input type="text" id="ownerName" placeholder="×©× ××œ×">
            </div>
            
            <div class="form-group" style="margin-bottom: 15px;">
                <label>×”×¢×¨×•×ª ×××©×¨:</label>
                <textarea id="ownerRemarks" placeholder="×”×¢×¨×•×ª, ×ª×™×§×•× ×™×, ××• ×”× ×—×™×•×ª..."></textarea>
            </div>
            
            <canvas id="ownerSignature" class="signature-pad" width="800" height="150"></canvas>
            <div class="signature-controls">
                <button class="btn-clear" onclick="clearSignature('owner')">ğŸ—‘ï¸ × ×§×”</button>
                <button class="btn-save" onclick="saveSignature('owner')">ğŸ’¾ ×©××•×¨ ×—×ª×™××”</button>
            </div>
        </div>

        <!-- Photo Upload (Alternative for hard copy) -->
        <div class="section" id="photoSection" style="display:none;">
            <div class="section-title">
                <span>ğŸ“·</span> ×¦×™×œ×•× ××¡××š ×—×ª×•× (××œ×˜×¨× ×˜×™×‘×” ×œ×—×ª×™××” ×“×™×’×™×˜×œ×™×ª)
            </div>
            
            <div class="alert alert-info">
                <span>ğŸ’¡</span>
                <div>
                    ×× ×”×‘×¢×œ/×× ×”×œ ×”×¢×“×™×£ ×œ×—×ª×•× ×¢×œ ×¢×•×ª×§ ××•×“×¤×¡, ×¦×œ× ××ª ×”××¡××š ×”×—×ª×•× ×•×”×¢×œ×” ×›××Ÿ
                </div>
            </div>
            
            <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
                <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“¸</div>
                <div style="font-weight: 600; margin-bottom: 5px;">×œ×—×¥ ×œ×¦×™×œ×•×/×”×¢×œ××ª ×ª××•× ×”</div>
                <div style="font-size: 13px; color: #666;">×ª××•× ×ª ××¡××š ×—×ª×•×</div>
                <input type="file" id="photoInput" accept="image/*" capture="environment" multiple>
            </div>
            
            <div id="photoPreview" class="photo-preview"></div>
            
            <div class="form-group" style="margin-top: 15px;">
                <label>×”×¢×¨×ª ×× ×”×œ ×¢×‘×•×“×” ×¢×œ ×”××¡××š:</label>
                <textarea id="photoRemarks" placeholder="×”×¢×¨×•×ª ×¢×œ ×”××¡××š ×”×—×ª×•× ×©×”×ª×§×‘×œ..."></textarea>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="section">
            <div class="action-buttons">
                <button class="btn btn-success" onclick="signAndSend()">
                    <span>âœï¸</span> ×—×ª×•× ×•×©×œ×—
                </button>
                <button class="btn btn-whatsapp" onclick="shareViaWhatsApp()">
                    <span>ğŸ“±</span> WhatsApp
                </button>
                <button class="btn btn-email" onclick="shareViaEmail()">
                    <span>ğŸ“§</span> Email
                </button>
                <button class="btn btn-primary" onclick="printReport()">
                    <span>ğŸ–¨ï¸</span> ×”×“×¤×¡
                </button>
                <button class="btn btn-info" onclick="saveReport()">
                    <span>ğŸ’¾</span> ×©××•×¨
                </button>
                <button class="btn btn-warning" onclick="loadReport()">
                    <span>ğŸ“‚</span> ×˜×¢×Ÿ
                </button>
            </div>
        </div>

        <!-- Modal for Owner Validation -->
        <div id="ownerModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">××™×©×•×¨ ×‘×¢×œ/×× ×”×œ ×¤×¨×•×™×™×§×˜</div>
                
                <div class="alert alert-info">
                    <span>â„¹ï¸</span>
                    <div>
                        ××¡××š ×–×” × ×©×œ×— ××œ×™×š ×œ××™×©×•×¨. ×× × ×‘×“×•×§ ××ª ×”×¤×¨×˜×™×, ×”×•×¡×£ ×”×¢×¨×•×ª ×‘××™×“×ª ×”×¦×•×¨×š, ×•×—×ª×•×.
                    </div>
                </div>
                
                <div class="form-group">
                    <label>××¤×©×¨×•×ª ××™×©×•×¨:</label>
                    <select id="approvalMethod" onchange="toggleApprovalMethod()">
                        <option value="digital">×—×ª×™××” ×“×™×’×™×˜×œ×™×ª</option>
                        <option value="hardcopy">×—×ª×™××” ×¢×œ ××¡××š ××•×“×¤×¡</option>
                    </select>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-success" onclick="approveReport()">××©×¨ ×•×©×œ×— ×—×–×¨×”</button>
                    <button class="btn btn-primary" onclick="closeModal()">×¡×’×•×¨</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Global State
        let reportData = {
            status: 'draft',
            currentStep: 1,
            projectInfo: {},
            workforce: [],
            activities: [],
            signatures: {
                foreman: null,
                owner: null
            },
            photos: [],
            timestamps: {
                created: null,
                foremanSigned: null,
                sent: null,
                ownerSigned: null,
                completed: null
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initSignaturePads();
            setDefaultDate();
            loadFromLocalStorage();
            
            // Photo upload handler
            document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
        });

        // Set default date
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
        }

        // Signature Pads
        let foremanPad, ownerPad;

        function initSignaturePads() {
            foremanPad = initPad('foremanSignature');
            ownerPad = initPad('ownerSignature');
        }

        function initPad(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches ? e.touches[0] : e;
                return {
                    x: touch.clientX - rect.left,
                    y: touch.clientY - rect.top
                };
            }

            function startDrawing(e) {
                e.preventDefault();
                isDrawing = true;
                const pos = getPos(e);
                lastX = pos.x;
                lastY = pos.y;
            }

            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                
                const pos = getPos(e);
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                
                lastX = pos.x;
                lastY = pos.y;
            }

            function stopDrawing() {
                isDrawing = false;
            }

            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);

            return { canvas, ctx };
        }

        function clearSignature(type) {
            const pad = type === 'foreman' ? foremanPad : ownerPad;
            pad.ctx.clearRect(0, 0, pad.canvas.width, pad.canvas.height);
        }

        function saveSignature(type) {
            const pad = type === 'foreman' ? foremanPad : ownerPad;
            const imageData = pad.canvas.toDataURL('image/png');
            reportData.signatures[type] = imageData;
            
            alert('âœ… ×—×ª×™××” × ×©××¨×” ×‘×”×¦×œ×—×”!');
            
            if (type === 'foreman') {
                reportData.timestamps.foremanSigned = new Date().toISOString();
            } else {
                reportData.timestamps.ownerSigned = new Date().toISOString();
            }
        }

        // Add table rows
        function addRow(tableType) {
            const tbody = document.getElementById(tableType + 'Body');
            const newRow = tbody.rows[0].cloneNode(true);
            
            // Clear inputs
            const inputs = newRow.getElementsByTagName('input');
            for (let input of inputs) {
                input.value = '';
            }
            
            tbody.appendChild(newRow);
        }

        // Collect form data
        function collectFormData() {
            return {
                projectName: document.getElementById('projectName').value,
                reportDate: document.getElementById('reportDate').value,
                foremanName: document.getElementById('foremanName').value,
                weather: document.getElementById('weather').value,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                breakHours: document.getElementById('breakHours').value,
                generalNotes: document.getElementById('generalNotes').value,
                workforce: collectTableData('workforce'),
                activities: collectTableData('activities'),
                ownerName: document.getElementById('ownerName').value,
                ownerRemarks: document.getElementById('ownerRemarks').value,
                photoRemarks: document.getElementById('photoRemarks').value
            };
        }

        function collectTableData(tableType) {
            const tbody = document.getElementById(tableType + 'Body');
            const data = [];
            
            for (let row of tbody.rows) {
                const inputs = row.getElementsByTagName('input');
                const rowData = [];
                for (let input of inputs) {
                    rowData.push(input.value);
                }
                if (rowData.some(val => val.trim() !== '')) {
                    data.push(rowData);
                }
            }
            
            return data;
        }

        // Sign and Send
        function signAndSend() {
            if (!reportData.signatures.foreman) {
                alert('âŒ ×™×© ×œ×—×ª×•× ×¢×œ ×”×“×•×— ×œ×¤× ×™ ×©×œ×™×—×”');
                return;
            }
            
            reportData.projectInfo = collectFormData();
            reportData.status = 'sent';
            reportData.currentStep = 2;
            reportData.timestamps.sent = new Date().toISOString();
            
            updateWorkflowUI();
            updateStatusBadge();
            
            alert('âœ… ×“×•×— × ×—×ª× ×•××•×›×Ÿ ×œ×©×œ×™×—×”!\n\n×›×¢×ª ×‘×—×¨ WhatsApp ××• Email ×œ×©×œ×™×—×” ×œ×‘×¢×œ/×× ×”×œ ×”×¤×¨×•×™×™×§×˜.');
        }

        // Share via WhatsApp
        function shareViaWhatsApp() {
            const data = collectFormData();
            
            let message = `ğŸ“ *×™×•××Ÿ ×¢×‘×•×“×” ×™×•××™*\n\n`;
            message += `ğŸ—ï¸ *×¤×¨×•×™×™×§×˜:* ${data.projectName}\n`;
            message += `ğŸ“… *×ª××¨×™×š:* ${data.reportDate}\n`;
            message += `ğŸ‘· *×× ×”×œ ×¢×‘×•×“×”:* ${data.foremanName}\n\n`;
            
            if (data.generalNotes) {
                message += `ğŸ“ *×”×¢×¨×•×ª:*\n${data.generalNotes}\n\n`;
            }
            
            message += `âœï¸ *××¦×•×¨×£:* ×“×•×— ××œ× ×¢× ×—×ª×™××”\n`;
            message += `\nğŸ”— ×œ×—×¥ ×œ×¤×ª×™×—×ª ×”×“×•×— ×”××œ×`;
            
            const whatsappURL = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappURL, '_blank');
        }

        // Share via Email
        function shareViaEmail() {
            const data = collectFormData();
            
            const subject = `×™×•××Ÿ ×¢×‘×•×“×” - ${data.projectName} - ${data.reportDate}`;
            
            let body = `×“×•×— ×™×•××™ ×:\n`;
            body += `×¤×¨×•×™×™×§×˜: ${data.projectName}\n`;
            body += `×ª××¨×™×š: ${data.reportDate}\n`;
            body += `×× ×”×œ ×¢×‘×•×“×”: ${data.foremanName}\n\n`;
            
            if (data.generalNotes) {
                body += `×”×¢×¨×•×ª:\n${data.generalNotes}\n\n`;
            }
            
            body += `××¦×•×¨×£ ×“×•×— ××œ× ×¢× ×—×ª×™××”.\n`;
            body += `\n× × ×œ××©×¨ ×•×œ×©×œ×•×— ×—×–×¨×”.`;
            
            const mailtoURL = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = mailtoURL;
        }

        // Print Report
        function printReport() {
            window.print();
        }

        // Save to localStorage
        function saveReport() {
            reportData.projectInfo = collectFormData();
            localStorage.setItem('stonhardWorkJournal', JSON.stringify(reportData));
            alert('âœ… ×“×•×— × ×©××¨ ×‘×”×¦×œ×—×”!');
        }

        // Load from localStorage
        function loadReport() {
            const saved = localStorage.getItem('stonhardWorkJournal');
            if (saved) {
                reportData = JSON.parse(saved);
                populateForm(reportData.projectInfo);
                updateWorkflowUI();
                updateStatusBadge();
                alert('âœ… ×“×•×— × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”!');
            } else {
                alert('âŒ ×œ× × ××¦× ×“×•×— ×©××•×¨');
            }
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('stonhardWorkJournal');
            if (saved) {
                reportData = JSON.parse(saved);
                if (reportData.projectInfo) {
                    populateForm(reportData.projectInfo);
                }
                updateWorkflowUI();
                updateStatusBadge();
            }
        }

        function populateForm(data) {
            if (!data) return;
            
            document.getElementById('projectName').value = data.projectName || '';
            document.getElementById('reportDate').value = data.reportDate || '';
            document.getElementById('foremanName').value = data.foremanName || '';
            document.getElementById('weather').value = data.weather || '';
            document.getElementById('startTime').value = data.startTime || '';
            document.getElementById('endTime').value = data.endTime || '';
            document.getElementById('breakHours').value = data.breakHours || 0;
            document.getElementById('generalNotes').value = data.generalNotes || '';
        }

        // Photo Upload
        function handlePhotoUpload(e) {
            const files = e.target.files;
            const preview = document.getElementById('photoPreview');
            
            for (let file of files) {
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    const photoData = event.target.result;
                    reportData.photos.push(photoData);
                    
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'photo-item';
                    photoDiv.innerHTML = `
                        <img src="${photoData}" alt="××¡××š ×—×ª×•×">
                        <button class="remove-photo" onclick="removePhoto(${reportData.photos.length - 1})">Ã—</button>
                    `;
                    preview.appendChild(photoDiv);
                };
                
                reader.readAsDataURL(file);
            }
        }

        function removePhoto(index) {
            reportData.photos.splice(index, 1);
            
            // Rebuild preview
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';
            reportData.photos.forEach((photo, idx) => {
                const photoDiv = document.createElement('div');
                photoDiv.className = 'photo-item';
                photoDiv.innerHTML = `
                    <img src="${photo}" alt="××¡××š ×—×ª×•×">
                    <button class="remove-photo" onclick="removePhoto(${idx})">Ã—</button>
                `;
                preview.appendChild(photoDiv);
            });
        }

        // Workflow UI
        function updateWorkflowUI() {
            const steps = document.querySelectorAll('.workflow-step');
            steps.forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');
                
                if (stepNum < reportData.currentStep) {
                    step.classList.add('completed');
                } else if (stepNum === reportData.currentStep) {
                    step.classList.add('active');
                }
            });
            
            // Show/hide relevant sections
            if (reportData.currentStep >= 3) {
                document.getElementById('ownerSection').style.display = 'block';
                document.getElementById('photoSection').style.display = 'block';
            }
        }

        function updateStatusBadge() {
            const badge = document.getElementById('currentStatus');
            badge.className = 'status-badge';
            
            switch(reportData.status) {
                case 'draft':
                    badge.classList.add('status-draft');
                    badge.textContent = '×˜×™×•×˜×”';
                    break;
                case 'sent':
                    badge.classList.add('status-sent');
                    badge.textContent = '× ×©×œ×— ×œ××™×©×•×¨';
                    break;
                case 'validated':
                    badge.classList.add('status-validated');
                    badge.textContent = '××•×©×¨';
                    break;
                case 'completed':
                    badge.classList.add('status-completed');
                    badge.textContent = '×”×•×©×œ×';
                    break;
            }
        }

        // Modal
        function openModal() {
            document.getElementById('ownerModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('ownerModal').classList.remove('active');
        }

        function toggleApprovalMethod() {
            const method = document.getElementById('approvalMethod').value;
            const ownerSection = document.getElementById('ownerSection');
            const photoSection = document.getElementById('photoSection');
            
            if (method === 'digital') {
                ownerSection.style.display = 'block';
                photoSection.style.display = 'none';
            } else {
                ownerSection.style.display = 'none';
                photoSection.style.display = 'block';
            }
        }

        function approveReport() {
            const method = document.getElementById('approvalMethod').value;
            
            if (method === 'digital') {
                if (!reportData.signatures.owner) {
                    alert('âŒ ×™×© ×œ×—×ª×•× ×¢×œ ×”×“×•×—');
                    return;
                }
            } else {
                if (reportData.photos.length === 0) {
                    alert('âŒ ×™×© ×œ×”×¢×œ×•×ª ×ª××•× ×” ×©×œ ×”××¡××š ×”×—×ª×•×');
                    return;
                }
            }
            
            reportData.status = 'validated';
            reportData.currentStep = 4;
            reportData.timestamps.completed = new Date().toISOString();
            
            updateWorkflowUI();
            updateStatusBadge();
            closeModal();
            
            alert('âœ… ×“×•×— ××•×©×¨ ×•× ×©×œ×— ×—×–×¨×” ×œ×× ×”×œ ×”×¢×‘×•×“×”!');
        }

        // Print styles
        const style = document.createElement('style');
        style.textContent = `
            @media print {
                body { background: white; }
                .header, .section { box-shadow: none; border: 1px solid #ddd; }
                .action-buttons, .add-row-btn, .signature-controls, .workflow-steps { display: none; }
                .section { page-break-inside: avoid; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
